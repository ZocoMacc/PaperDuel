<!doctype html>
<html>
<head>
 <meta charset="utf-8" />
 <title>PaperDuel â€“ Competitive Backtesting</title>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 
 <!-- Lightweight Charts standalone build -->
 <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"
 onerror="var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js';document.head.appendChild(s);">
 </script>

 <style>
  /* Combined and Cleaned CSS */
  body {
   margin: 0; background: #0d0d0d; color: #ddd; font-family: monospace; height: 100vh; overflow: hidden;
  }
  #layout { display: flex; height: 100%; width: 100%; }
  /* CRITICAL: Adjust width to accommodate duel stats */
  #left-panel { width: 350px; border-right: 1px solid #222; display: flex; flex-direction: column; background: #1b1b1b; }
  #left-panel h3 { margin: 0; padding: 10px; border-bottom: 1px solid #333; background: #1b1b1b; text-align: center; font-weight: bold; color: #eee; }
  #console { flex: 1; padding: 8px; overflow-y: auto; font-size: 12px; line-height: 1.4; background: #0b0b0b; }
  #right-panel { flex: 1; display: flex; flex-direction: column; min-width:0; background: #1b1b1b; }
  #chart { flex: 1; min-height:0; background: #1e1e1e; padding:0; margin:0; }
  #command-panel { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; padding: 10px; border-top: 1px solid #333; background: #111; }
  input[type="number"], select { padding: 6px; border: 1px solid #444; border-radius: 4px; background: #2a2a2a; color: #eee; width: 60px; }
  button { padding: 6px 10px; border: 1px solid #444; border-radius: 4px; background: #222; color: #eee; cursor: pointer; transition: background .2s; }
  button:hover:not(:disabled) { background: #333; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Duel Specific Styling */
  .user-stat-card { 
   padding: 8px 12px; border: 1px solid #333; border-radius: 4px; margin-bottom: 8px; font-size: 13px;
   background: #151515;
  }
  /* CRITICAL STYLING: Highlights active trader */
  .user-stat-card.active { border-color: #3a6ea5; background: #181825; box-shadow: 0 0 5px rgba(58, 110, 165, 0.4); }
 .user-stat-card .pnl-val { font-weight: bold; }
  .pnl-val.profit { color: #00d980; }
  .pnl-val.loss Â  { color: #ff5252; }
  .user-stat-card .info-line { display: flex; justify-content: space-between; margin-top: 2px; }
  
  #login-container { padding: 10px; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }
 </style>
</head>

<body>
 
 <div id="layout">
  <!-- LEFT: Competitive Status and History -->
  <div id="left-panel">
   <h3>PaperDuel Battle Status</h3>
   
   <!-- 1. Login/Session Controls (Updated for Duel Start) -->
   <div id="login-container">
    <div id="auth-status" style="font-size:14px;">A: Logged In | B: Ready to Duel</div>

    <select id="asset-selector" style="width:100%;">
     <option value="ES">ES (E-mini S&P 500)</option>
     <option value="NQ">NQ (E-mini NASDAQ 100)</option>
    </select>
    <button id="start-duel">Start Duel</button>
   </div>

   <!-- 2. Player Status Cards Container -->
   <div id="player-status" style="padding: 10px;">
   <!-- Stats cards will be rendered here -->
   </div>
   <!-- 3. History Console -->
  <h3>Execution Log</h3>
   <pre id="console"></pre>
  </div>

  <!-- RIGHT: Chart and Command Panel -->
 <div id="right-panel">
   <div class="wrap" style="display:flex;flex-direction:column;min-height:100%;">
    <h1 id="header-status" style="margin:10px 12px 6px;">Replay (INACTIVE)</h1>
     <div id="chart" style="flex:1;min-height:0;"></div>

    <div id="command-panel" style="margin-top:10px;padding:10px;">
     
   <!-- User Selector -->
     <span style="font-weight:bold;">Trader:</span>
<button id="trader-a-btn" data-user-id="user_1" class="active">User A</button>
     <button id="trader-b-btn" data-user-id="user_2_opponent">User B</button>
     
     <span style="margin-left:15px; font-weight:bold;">Order Asset:</span>
     <select id="trade-asset-selector" style="width:70px;">
      <option value="ES">ES</option>
      <option value="NQ">NQ</option>
     </select>
     
    <span style="margin-left:15px; font-weight:bold;">Params:</span>
     Size <input id="size" type="number" value="1" min="1" disabled style="width:60px">
     SL <input id="sl" type="number" step="0.25" disabled style="width:80px">
     TP <input id="tp" type="number" step="0.25" disabled style="width:80px">
     
     <button id="buy" disabled>BUY</button>
     <button id="sell" disabled>SELL</button>
     <button id="flat" disabled>CLOSE</button>
     
    <span style="margin-left:20px; font-weight:bold;">Control:</span>
     <button id="next" disabled>Next Bar</button>
     <button id="play" disabled>Play</button>
    <button id="pause" disabled>Pause</button>
 </div>
    
    <!-- Removed the redundant console tag at the bottom -->
   </div>
  </div>
 </div>


<script>
/* ===== PaperDuel â€“ Core Competitive Frontend Script (Dual-User Ready) ===== */

const API_URL = ""; 
const WINDOW = 60;      
let chart, series; 
let battleId = null;
let currentBarIndex = 0;
let totalBars = 0;
let timer = null; 
let activeTradingUserId = 'user_1'; // Starts with User A's ID
// Map backend IDs to frontend display names
const USER_MAP = { 'user_1': 'User A', 'user_2_opponent': 'User B' };


/* ---- Helpers: Chart, Logging, etc. ---- */

function logLine(msg, color = '#9f9', isHeading = false) {
 const c = document.getElementById('console');
 const line = document.createElement('div');
 line.style.color = color;
 line.textContent = msg;
 if (isHeading) line.style.fontWeight = 'bold';
 c.appendChild(line);
 c.scrollTop = c.scrollHeight;
}

function clampWindow() {
 const to = currentBarIndex, from = Math.max(0, to - WINDOW);
 chart.timeScale().setVisibleLogicalRange({ from, to });
}

function stateToCandle(state) {
Â  const b = state.bar_data; 
Â  
Â  // 1. Convert timestamp to seconds (required by Lightweight Charts)
Â  const ts = Math.floor(new Date(b.timestamp.replace(' ', 'T') + 'Z').getTime()/1000);
Â  
Â  // 2. CRITICAL FIX: Use individual OHLC values from the bar_data object
Â  return { 
Â  Â  time: ts, 
Â  Â  open: b.open_es, 
Â  Â  high: b.high_es, 
Â  Â  low: b.low_es, 
Â  Â  close: b.close_es 
Â  };
}


// --- DOM MANIPULATION & STATE DISPLAY ---

function setControlsEnabled(enabled) {
 document.getElementById('size').disabled = !enabled;
 document.getElementById('sl').disabled = !enabled;
 document.getElementById('tp').disabled = !enabled;
 document.getElementById('buy').disabled = !enabled;
 document.getElementById('sell').disabled = !enabled;
 document.getElementById('flat').disabled = !enabled;
 document.getElementById('next').disabled = !enabled;
 document.getElementById('play').disabled = !enabled;
 document.getElementById('pause').disabled = !enabled;
 document.getElementById('trade-asset-selector').disabled = !enabled;
 
 // Enable/Disable trader buttons based on general control state
 document.getElementById('trader-a-btn').disabled = !enabled;
 document.getElementById('trader-b-btn').disabled = !enabled;
}

function updateTraderUI(state) {
 const container = document.getElementById('player-status');
 container.innerHTML = ''; // Clear existing cards
 
 // NOTE: The backend did not pass currentBarIndex or totalBars, relying on JS counter 'idx'
 
 document.getElementById('header-status').textContent = `Replay (${state.bar_data.timestamp}) | ${state.status}`;
 
 // 1. Render each trader's card
 for (const [userId, stats] of Object.entries(state.active_traders)) {
 const alias = USER_MAP[userId];
  const pnlClass = stats.unrealized_pnl_usd > 0 ? 'profit' : (stats.unrealized_pnl_usd < 0 ? 'loss' : '');
 
Â  Â  const card = document.createElement('div');
Â  Â  card.className = `user-stat-card ${userId === activeTradingUserId ? 'active' : ''}`;
Â  Â  card.innerHTML = `
Â  Â  Â  <div>
Â  Â  Â  Â  <b>${alias}</b> (Asset: ${stats.position_asset_symbol})
Â  Â  Â  </div>
Â  Â  Â  <div class="info-line">
Â  Â  Â  Â  <span>Equity:</span> <span>$${stats.equity.toFixed(2)}</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="info-line">
Â  Â  Â  Â  <span>PnL:</span> <span class="pnl-val ${pnlClass}">$${stats.unrealized_pnl_usd.toFixed(2)}</span>
Â  Â  Â  </div>
Â  Â  Â  ${stats.in_position ? `
Â  Â  Â  Â  <div class="info-line" style="color:#00d980;">
Â  Â  Â  Â  Â  <span>${stats.position_direction > 0 ? 'LONG' : 'SHORT'} ${stats.active_position_size} @ </span> <span>${stats.entry_price_points.toFixed(2)}</span>
Â  Â  Â  Â  </div>` : '<div>FLAT</div>'}
Â  Â  `;
Â  Â  container.appendChild(card);
Â  }

Â  // 2. Log dual-asset prices (Time, ES Close, NQ Close)
Â  logLine(`TIME: ${state.bar_data.timestamp} | ES: ${state.bar_data.close_es.toFixed(2)} | NQ: ${state.bar_data.close_nq.toFixed(2)}`, '#aaa');
Â  
Â  // 3. Log auto-exit notification
Â  if (state.exit_notification) {
Â  Â  logLine(`ðŸ“¢ ${state.exit_notification}`, '#ff5252', true);
Â  }
}


/* ---- API CALLS AND LOGIC ---- */

async function startDuel(asset="ES", users=["user_1", "user_2_opponent"]) {
Â  try {
Â  Â  // 1. Start the duel on the backend (Hardcoding User A and User B IDs for simplicity)
Â  Â  const r = await fetch("/battle/start", {
Â  Â  Â  method:"POST", 
Â  Â  Â  headers:{"Content-Type":"application/json"},
Â  Â  Â  body: JSON.stringify({ asset, user_ids: users })
Â  Â  });
Â  Â  const d = await r.json();
Â  Â  
Â  Â  if (!r.ok || d.error) throw new Error(d.detail || d.error);
Â  Â  
Â  Â  battleId = d.battle_id;
Â  Â  // NOTE: ASSET_SYMBOL is not used in the final code, using trade-asset-selector instead
Â  Â  
Â  Â  logLine(`Duel started for ${asset}. ID: ${battleId}`, '#0f0', true);
Â  Â  
Â  Â  // 2. Seed the chart and UI with initial state (first bar)
Â  Â  setControlsEnabled(true);
Â  Â  document.getElementById('start-duel').disabled = true;
Â  Â  series.setData([]); // Clear old data
Â  Â  currentBarIndex = 0;
Â  Â  await seedEngine(30); // Advance 30 bars immediately
Â  Â  
Â  } catch (e) {
Â  Â  console.error("Failed to start duel:", e);
Â  Â  logLine(`Failed to start duel: ${e.message}`, '#f00');
Â  Â  setControlsEnabled(false);
Â  Â  document.getElementById('start-duel').disabled = false;
Â  }
}

async function advance() {
Â  try {
Â  Â  if (!battleId) return;
Â  Â  const r = await fetch(`/battle/${battleId}/advance`, { method:"POST" });
Â  Â  const st = await r.json();
Â  Â  
Â  Â  if (st.status.startsWith("ENDED") || st.status.startsWith("LOST")) {
Â  Â  Â  pause();
Â  Â  Â  logLine(`\nðŸ“¢ BATTLE OVER: ${st.status}`, '#ff5252', true);
Â  Â  Â  setControlsEnabled(false);
Â  Â  }
Â  Â  
Â  Â  // Update chart using the ES close price as the main candle visual
Â  Â  series.update(stateToCandle(st));
Â  Â  currentBarIndex++;
Â  Â  clampWindow();
Â  Â  updateTraderUI(st);
Â  Â  
Â  Â  return st;
Â  } catch (e) {
Â  Â  pause();
Â  Â  console.error("Advance failed:", e);
Â  Â  logLine(`Connection Error: ${e.message}`, '#f00');
Â  }
}


async function placeOrder(action) {
Â  const size = Number(document.getElementById('size').value) || 0;
Â  const sl = document.getElementById('sl').value ? Number(document.getElementById('sl').value) : null;
Â  const tp = document.getElementById('tp').value ? Number(document.getElementById('tp').value) : null;
Â  
Â  const user_id = activeTradingUserId; // CRITICAL: Uses the ID selected by the A/B buttons
Â  const traded_asset = document.getElementById('trade-asset-selector').value; 
Â  
Â  // Validation
Â  if (size <= 0 && action !== 'CLOSE') return logLine("Size must be > 0.", '#ff5252');

Â  const payload = { 
Â  Â  battle_id: battleId, 
Â  Â  user_id, 
Â  Â  action, 
Â  Â  size, 
Â  Â  sl, 
Â  Â  tp,
Â  Â  traded_asset
Â  };

Â  try {
Â  Â  const r = await fetch("/battle/trade", {
Â  Â  Â  method:"POST", 
Â  Â  Â  headers:{"Content-Type":"application/json"},
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });
Â  Â  const result = await r.json();
Â  Â  
Â  Â  if (!r.ok || result.error) {
Â  Â  Â  logLine(`TRADE FAILED: ${result.error || "Unknown Error"}`, '#f00');
Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  logLine(`[${USER_MAP[user_id]}] ${action} ${size} @ ${traded_asset}`, '#00d980');

Â  Â  // If the trade was an entry or close, we advance the bar immediately for fill
Â  Â  if (result.result === 'Executed' || result.result === 'Closed') {
Â  Â  Â  await advance();
Â  Â  }
Â  Â  
Â  } catch(e) {
Â  Â  console.error("Trade API call failed:", e);
Â  Â  logLine("Trade connection error. Check server.", '#f00');
Â  }
}

function setActiveTrader(userId) {
Â  activeTradingUserId = userId;
Â  
Â  // Visually highlight the active user button
Â  document.getElementById('trader-a-btn').classList.toggle('active', userId === 'user_1');
Â  document.getElementById('trader-b-btn').classList.toggle('active', userId === 'user_2_opponent');
}


/* ---- engine-driven chart flow ---- */

async function seedEngine(n) {
Â  const data = [];
Â  for (let k=0; k<n; k++) {
Â  Â  const st = await advance();
Â  Â  if (st.status !== "RUNNING") break; 
Â  Â  data.push(stateToCandle(st));
Â  }
Â  series.setData(data);
Â  chart.timeScale().fitContent();
Â  clampWindow();
}

function play(speed=200){ 
Â  if (timer) return; 
Â  document.getElementById('play').disabled = true;
Â  document.getElementById('pause').disabled = false;
Â  timer = setInterval(advance, speed); 
}
function pause(){ 
Â  if (timer){ 
Â  Â  clearInterval(timer); 
Â  Â  timer = null; 
Â  Â  document.getElementById('play').disabled = false;
Â  Â  document.getElementById('pause').disabled = true;
Â  } 
}


/* ---- boot on page load ---- */
window.addEventListener("load", async () => {
Â  // 1) create chart 
Â  const el = document.getElementById('chart');
Â  chart = LightweightCharts.createChart(el, {
Â  Â  width: el.clientWidth, height: el.clientHeight, 
Â  Â  layout: { background: { color: '#1e1e1e' }, textColor: '#ddd' },
Â  Â  grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } },
Â  Â  rightPriceScale: { borderVisible: false },
Â  Â  timeScale: { borderVisible:false, timeVisible:true, secondsVisible:false },
Â  });
Â  series = chart.addCandlestickSeries({ upColor: '#00d980', downColor: '#ff5252', borderUpColor: '#00d980', borderDownColor: '#ff5252', wickUpColor: '#00d980', wickDownColor: '#ff5252' });


Â  // Resize observer for responsive chart sizing
Â  new ResizeObserver(entries => {
Â  Â  for (const e of entries) {
Â  Â  Â  const { width, height } = e.contentRect;
Â  Â  Â  chart.applyOptions({ width: Math.max(0, Math.floor(width)), height: Math.max(0, Math.floor(height)) });
Â  Â  }
Â  }).observe(el);

Â  // 2) wire buttons
Â  document.getElementById('start-duel').onclick = () => startDuel(document.getElementById('asset-selector').value); 
Â  
Â  document.getElementById('play').onclick Â = () => play(200);
Â  document.getElementById('pause').onclick = pause;
Â  document.getElementById('next').onclick = advance;
Â  
Â  document.getElementById('buy').onclick = () => placeOrder("BUY");
Â  document.getElementById('sell').onclick = () => placeOrder("SELL");
Â  document.getElementById('flat').onclick Â = () => placeOrder("CLOSE");
Â  
Â  document.getElementById('trader-a-btn').onclick = () => setActiveTrader('user_1');
Â  document.getElementById('trader-b-btn').onclick = () => setActiveTrader('user_2_opponent');

Â  // Initial setup
Â  setControlsEnabled(false);
Â  document.getElementById('start-duel').disabled = false;
Â  setActiveTrader('user_1'); // Initialize User A as active
});
</script>
